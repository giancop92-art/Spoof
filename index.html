<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PesoSenzaBilancia - Smart Kitchen</title>
    
    <!-- PWA Manifest Injection -->
    <script>
        const manifest = {
            "name": "Smart Kitchen Scale",
            "short_name": "KitchenScale",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8fafc",
            "theme_color": "#f59e0b",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/1046/1046771.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any maskable"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-gradient);
            color: #1e293b;
            min-height: 100vh;
            user-select: none;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        .mode-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mode-btn.active {
            background: white;
            color: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .selectable-card {
            transition: all 0.2s ease;
            border: 2px solid #f1f5f9;
            background: white;
        }

        .selectable-card.active {
            border-color: var(--primary);
            background: #fffbeb;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
        }

        .display-unit {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        #customSelectOptions {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s;
            opacity: 0;
        }

        #customSelectOptions.open {
            max-height: 300px;
            opacity: 1;
            overflow-y: auto;
        }

        .visual-tool-unit {
            display: inline-block;
            position: relative;
            margin: 0 2px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .visual-tool-unit.half {
            clip-path: inset(0 50% 0 0);
            opacity: 0.7;
        }

        .ai-panel {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 sm:p-8">

    <div class="main-card w-full max-w-[440px] rounded-[2.5rem] overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-8 text-center relative">
            <h1 class="text-2xl font-800 text-white tracking-tight uppercase italic mb-4">Smart Kitchen Scale</h1>
            
            <div class="inline-flex bg-black/10 backdrop-blur-md p-1 rounded-2xl w-full">
                <button onclick="setMode('toWeight')" id="tab-toWeight" class="mode-btn active flex-1 py-2.5 text-[11px] font-bold uppercase rounded-xl text-amber-700">
                    Strumento â†’ Grammi
                </button>
                <button onclick="setMode('toTool')" id="tab-toTool" class="mode-btn flex-1 py-2.5 text-[11px] font-bold uppercase rounded-xl text-white/70">
                    Grammi â†’ Strumento
                </button>
            </div>
        </div>

        <div class="p-8 space-y-7">
            <!-- 1. Alimento -->
            <section class="relative">
                <label class="text-[11px] font-800 text-slate-400 uppercase tracking-widest block mb-3">Alimento</label>
                <div class="relative">
                    <div id="customSelectTrigger" onclick="toggleDropdown()" class="w-full bg-white border-2 border-slate-100 rounded-2xl px-5 py-4 text-slate-700 font-semibold flex items-center justify-between cursor-pointer hover:border-amber-200 transition-all">
                        <div id="selectedFoodContent" class="flex items-center space-x-3">
                            <span id="selectedIcon">ðŸŒ¾</span>
                            <span id="selectedText">Farina</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                    <div id="customSelectOptions" class="absolute z-50 w-full mt-2 bg-white border border-slate-100 shadow-xl rounded-2xl overflow-hidden"></div>
                </div>
            </section>

            <!-- 2. Utensile -->
            <section id="toolSection">
                <label id="toolLabel" class="text-[11px] font-800 text-slate-400 uppercase tracking-widest block mb-3">Scegli lo Strumento</label>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="selectTool('cucchiaio')" id="btn-cucchiaio" class="selectable-card active p-4 rounded-2xl flex items-center space-x-4 shadow-sm">
                        <span class="text-3xl">ðŸ¥„</span>
                        <span class="text-[11px] font-bold uppercase text-slate-600">Cucchiaio</span>
                    </button>
                    <button onclick="selectTool('cucchiaino')" id="btn-cucchiaino" class="selectable-card p-4 rounded-2xl flex items-center space-x-4 shadow-sm">
                        <span class="text-2xl">ðŸ¥„</span>
                        <span class="text-[11px] font-bold uppercase text-slate-600">Cucchiaino</span>
                    </button>
                    <button onclick="selectTool('tazzina')" id="btn-tazzina" class="selectable-card p-4 rounded-2xl flex items-center space-x-4 shadow-sm">
                        <span class="text-3xl">â˜•</span>
                        <span class="text-[11px] font-bold uppercase text-slate-600">Tazzina</span>
                    </button>
                    <button onclick="selectTool('bicchiere')" id="btn-bicchiere" class="selectable-card p-4 rounded-2xl flex items-center space-x-4 shadow-sm">
                        <span class="text-3xl">ðŸ¥›</span>
                        <span class="text-[11px] font-bold uppercase text-slate-600">Bicchiere</span>
                    </button>
                </div>
            </section>

            <!-- 2b. Taratura -->
            <section id="levelSection" class="bg-slate-50/50 p-5 rounded-3xl border border-slate-100">
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="setLevel('raso')" id="btn-raso" class="level-button active bg-white border border-slate-200 py-3 rounded-xl text-[10px] font-bold uppercase shadow-sm">Raso</button>
                    <button onclick="setLevel('colmo')" id="btn-colmo" class="level-button bg-white border border-slate-200 py-3 rounded-xl text-[10px] font-bold uppercase shadow-sm">Colmo</button>
                    <button onclick="setLevel('strabordante')" id="btn-strabordante" class="level-button bg-white border border-slate-200 py-3 rounded-xl text-[10px] font-bold uppercase shadow-sm">Pieno</button>
                </div>
            </section>

            <!-- 3. Input QuantitÃ  Simmetrico -->
            <section>
                <div class="flex items-center justify-between space-x-4 bg-white rounded-[1.5rem] p-3 border-2 border-slate-100 focus-within:border-amber-500 transition-all shadow-sm">
                    <button onclick="adjustVal(-1)" class="w-12 h-12 flex items-center justify-center bg-slate-50 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded-xl transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4" /></svg>
                    </button>
                    <div class="flex-1 flex flex-col items-center">
                        <label id="inputLabel" class="text-[9px] font-800 text-slate-400 uppercase tracking-widest mb-1 text-center">QuantitÃ  UnitÃ </label>
                        <input type="number" id="mainInput" value="1" class="w-full text-center text-3xl font-800 text-slate-800 bg-transparent border-none focus:ring-0 p-0" spellcheck="false">
                    </div>
                    <button onclick="adjustVal(1)" class="w-12 h-12 flex items-center justify-center bg-slate-50 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded-xl transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
            </section>

            <!-- 4. Display -->
            <div class="display-unit rounded-[2.5rem] p-8 text-center relative overflow-hidden group">
                <div id="resultLabel" class="text-[11px] font-700 uppercase tracking-[0.3em] text-slate-400 mb-2">Peso Calcolato</div>
                <div id="mainResult" class="text-6xl font-900 text-white tracking-tighter mb-4">0<span class="text-2xl text-amber-500 ml-1">g</span></div>
                <div id="visualToolsContainer" class="hidden flex flex-wrap justify-center gap-1 mb-4"></div>
                <div class="h-[1px] w-12 bg-slate-700 mx-auto mb-3"></div>
                <div id="subResult" class="text-amber-500 font-700 text-sm tracking-wide uppercase">~ 0 KCAL</div>
            </div>

            <!-- 5. Gemini AI -->
            <div class="ai-panel rounded-3xl p-6 space-y-4 shadow-sm">
                <div class="flex items-center space-x-2"><span class="text-blue-600">âœ¨</span><h3 class="text-[12px] font-800 uppercase tracking-widest text-blue-800">Cucina Intelligente</h3></div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="askGemini('recipe')" class="bg-white hover:bg-blue-50 text-blue-700 font-bold py-3 px-4 rounded-xl text-[10px] uppercase shadow-sm border border-blue-200 transition-all active:scale-95">Cosa Cucino? âœ¨</button>
                    <button onclick="askGemini('nutrition')" class="bg-white hover:bg-blue-50 text-blue-700 font-bold py-3 px-4 rounded-xl text-[10px] uppercase shadow-sm border border-blue-200 transition-all active:scale-95">Valori Nutrizionali âœ¨</button>
                </div>
                <div id="aiResponseContainer" class="hidden">
                    <div id="aiLoading" class="hidden space-y-2"><div class="h-3 w-full loading-shimmer rounded"></div><div class="h-3 w-3/4 loading-shimmer rounded"></div></div>
                    <div id="aiText" class="text-[13px] text-slate-700 leading-relaxed bg-white/50 p-4 rounded-2xl border border-white whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Utilizzo della chiave dell'ambiente
        const apiKey = ""; 

        const db = {
            farina: { icon: "ðŸŒ¾", name: "Farina", weights: { cucchiaio: 12, cucchiaino: 4, tazzina: 60, bicchiere: 120 }, kcal100g: 364 },
            olio: { icon: "ðŸ«’", name: "Olio d'oliva", weights: { cucchiaio: 9, cucchiaino: 3, tazzina: 80, bicchiere: 180 }, kcal100g: 884 },
            zucchero: { icon: "ðŸ¬", name: "Zucchero", weights: { cucchiaio: 15, cucchiaino: 5, tazzina: 80, bicchiere: 180 }, kcal100g: 387 },
            sale: { icon: "ðŸ§‚", name: "Sale", weights: { cucchiaio: 18, cucchiaino: 6, tazzina: 110, bicchiere: 250 }, kcal100g: 0 },
            latte: { icon: "ðŸ¥›", name: "Latte", weights: { cucchiaio: 15, cucchiaino: 5, tazzina: 70, bicchiere: 200 }, kcal100g: 42 },
            riso: { icon: "ðŸš", name: "Riso", weights: { cucchiaio: 20, cucchiaino: 7, tazzina: 100, bicchiere: 170 }, kcal100g: 350 },
            pasta_corta: { icon: "ðŸ", name: "Pasta Corta", weights: { cucchiaio: 12, cucchiaino: 4, tazzina: 50, bicchiere: 80 }, kcal100g: 350 },
            miele: { icon: "ðŸ¯", name: "Miele", weights: { cucchiaio: 21, cucchiaino: 7, tazzina: 110, bicchiere: 280 }, kcal100g: 304 },
            burro: { icon: "ðŸ§ˆ", name: "Burro", weights: { cucchiaio: 14, cucchiaino: 5, tazzina: 90, bicchiere: 190 }, kcal100g: 717 },
            pangrattato: { icon: "ðŸž", name: "Pangrattato", weights: { cucchiaio: 10, cucchiaino: 3, tazzina: 60, bicchiere: 100 }, kcal100g: 395 }
        };

        const multipliers = { raso: 1, colmo: 1.5, strabordante: 2 };
        const toolIcons = { cucchiaio: "ðŸ¥„", cucchiaino: "ðŸ¥„", tazzina: "â˜•", bicchiere: "ðŸ¥›" };

        let currentMode = 'toWeight', currentTool = 'cucchiaio', currentLevel = 'raso', currentFoodKey = 'farina';
        
        const mainInput = document.getElementById('mainInput'), mainResult = document.getElementById('mainResult'), subResult = document.getElementById('subResult');
        const toolLabel = document.getElementById('toolLabel'), inputLabel = document.getElementById('inputLabel'), resultLabel = document.getElementById('resultLabel');
        const levelSection = document.getElementById('levelSection'), customSelectOptions = document.getElementById('customSelectOptions'), visualToolsContainer = document.getElementById('visualToolsContainer');

        function init() {
            Object.keys(db).forEach(key => {
                const food = db[key];
                const option = document.createElement('div');
                option.className = "food-option px-5 py-3 flex items-center space-x-3 cursor-pointer border-b border-slate-50 last:border-none";
                option.innerHTML = `<span>${food.icon}</span> <span class="text-sm font-semibold text-slate-700">${food.name}</span>`;
                option.onclick = () => selectFood(key);
                customSelectOptions.appendChild(option);
            });
            updateModeUI();
            calculate();
        }

        function toggleDropdown() { customSelectOptions.classList.toggle('open'); }
        function selectFood(key) {
            currentFoodKey = key;
            document.getElementById('selectedIcon').textContent = db[key].icon;
            document.getElementById('selectedText').textContent = db[key].name;
            customSelectOptions.classList.remove('open');
            calculate();
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(t => t.classList.toggle('active', t.id === `tab-${mode}`));
            updateModeUI();
            calculate();
        }

        function updateModeUI() {
            const isToWeight = currentMode === 'toWeight';
            toolLabel.textContent = isToWeight ? "Scegli lo Strumento" : "Converti In";
            inputLabel.textContent = isToWeight ? "QuantitÃ  UnitÃ " : "Grammi desiderati";
            resultLabel.textContent = isToWeight ? "Peso Calcolato" : "Dosaggio Stimato";
            mainInput.value = isToWeight ? 1 : 50;
            visualToolsContainer.classList.toggle('hidden', isToWeight);
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.selectable-card').forEach(btn => btn.classList.toggle('active', btn.id === `btn-${tool}`));
            levelSection.classList.toggle('hidden', !(tool === 'cucchiaio' || tool === 'cucchiaino'));
            calculate();
        }

        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-button').forEach(btn => btn.classList.toggle('active', btn.id === `btn-${level}`));
            calculate();
        }

        function adjustVal(amount) {
            let step = currentMode === 'toWeight' ? 1 : 10;
            mainInput.value = Math.max(1, (parseFloat(mainInput.value) || 0) + (amount * step));
            calculate();
        }

        function renderVisualTools(total) {
            visualToolsContainer.innerHTML = '';
            const icon = toolIcons[currentTool], full = Math.floor(total);
            const half = (total - full) >= 0.3 && (total - full) < 0.8, extra = (total - full) >= 0.8;
            for(let i = 0; i < (full + (extra ? 1 : 0)); i++) {
                const s = document.createElement('span'); s.className = "text-2xl visual-tool-unit"; s.textContent = icon;
                visualToolsContainer.appendChild(s);
            }
            if(half) {
                const s = document.createElement('span'); s.className = "text-2xl visual-tool-unit half"; s.textContent = icon;
                visualToolsContainer.appendChild(s);
            }
        }

        function calculate() {
            const food = db[currentFoodKey], val = parseFloat(mainInput.value) || 0;
            const mult = (currentTool === 'cucchiaio' || currentTool === 'cucchiaino') ? multipliers[currentLevel] : 1;
            const uw = food.weights[currentTool] * mult;

            if (currentMode === 'toWeight') {
                const g = Math.round(uw * val);
                mainResult.innerHTML = `${g}<span class="text-2xl text-amber-500 ml-1">g</span>`;
                subResult.textContent = `~ ${Math.round((g * food.kcal100g) / 100)} KCAL`;
            } else {
                const u = (val / uw).toFixed(1);
                mainResult.innerHTML = `${u}<span class="text-2xl text-amber-500 ml-1">PCS</span>`;
                subResult.textContent = `APPORTO: ~ ${Math.round((val * food.kcal100g) / 100)} KCAL`;
                renderVisualTools(parseFloat(u));
            }
        }

        // Funzione di chiamata AI con Exponential Backoff robusto
        async function fetchGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Sei un assistente culinario esperto. Fornisci risposte brevissime, utili e creative in italiano. Max 200 caratteri." }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "Nessun suggerimento disponibile.";
                    }
                } catch (err) {
                    // Errore silenzioso per il backoff
                }
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
            throw new Error("Connessione fallita.");
        }

        async function askGemini(type) {
            const container = document.getElementById('aiResponseContainer'), 
                  loading = document.getElementById('aiLoading'), 
                  textDiv = document.getElementById('aiText');
            
            container.classList.remove('hidden'); 
            loading.classList.remove('hidden'); 
            textDiv.innerText = '';
            
            // Calcolo dati correnti per il prompt
            const currentQuantity = mainResult.innerText.split('g')[0].trim() || mainResult.innerText.split('PCS')[0].trim();
            const foodName = db[currentFoodKey].name;
            
            const prompt = type === 'recipe' 
                ? `Dammi un'idea lampo per usare ${currentQuantity}g di ${foodName}.` 
                : `Quali sono le proprietÃ  principali di ${foodName} in questa quantitÃ  (${currentQuantity}g)?`;

            try {
                const result = await fetchGemini(prompt);
                loading.classList.add('hidden');
                textDiv.innerText = result;
            } catch (e) { 
                loading.classList.add('hidden'); 
                textDiv.innerText = "Spiacente, si Ã¨ verificato un errore di connessione. Riprova piÃ¹ tardi."; 
            }
        }

        mainInput.addEventListener('input', calculate);
        window.onload = () => {
            init(); 
            selectTool('cucchiaio');
        };
    </script>
</body>
</html>
