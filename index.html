<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <title>Chef Academy 2026 Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { --p-level: 0%; }
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: #f1f5f9; color: #1e293b; touch-action: none; 
      overflow: hidden; height: 100vh; -webkit-user-select: none; user-select: none;
    }
    
    .page { position: absolute; inset: 0; display: flex; flex-direction: column; height: 100%; }

    /* OUTPUT AREA */
    .sticky-output { 
        position: relative; z-index: 1000; 
        background: #0f172a; border-radius: 0 0 2.8rem 2.8rem;
        padding: 1.8rem; overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    .liquid-bg {
        position: absolute; bottom: 0; left: 0; width: 100%; 
        height: var(--p-level); 
        background: linear-gradient(0deg, rgba(251,191,36,0.2) 0%, rgba(251,191,36,0) 100%);
        transition: height 0.3s ease-out; z-index: 1;
    }

    /* DRAG & DELETE ZONE - MASSIMO LAYER */
    #drop-delete-zone { 
        position: fixed; top: 0; width: 100%; height: 130px; 
        background: #ef4444; z-index: 90000; /* Sotto l'elemento trascinato ma sopra tutto il resto */
        transform: translateY(-100%); display: flex; flex-direction: column; 
        align-items: center; justify-content: center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white;
    }
    #drop-delete-zone.visible { transform: translateY(0); }

    /* FAV ITEM DRAGGING FIX */
    .fav-item { 
        background: white; border-radius: 1.2rem; padding: 12px;
        min-width: 78px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        touch-action: none; position: relative; z-index: 10;
    }
    .fav-dragging { 
        z-index: 99999 !important; /* SOPRA IL CESTINO */
        position: fixed !important; 
        pointer-events: none;
        box-shadow: 0 40px 80px rgba(0,0,0,0.4) !important;
        transform: scale(1.2) !important;
    }

    /* COLLAPSIBLE FIX */
    .collapsible-content { 
        max-height: 0; overflow: hidden; 
        transition: max-height 0.5s cubic-bezier(0, 1, 0, 1); 
    }
    .collapsible-content.open { max-height: 1000px; transition: max-height 0.8s ease-in; }

    /* RULER */
    .ruler-container { position: relative; width: 100%; height: 75px; overflow: hidden; background: white; }
    .ruler-track { display: flex; align-items: flex-end; height: 100%; position: absolute; left: 50%; }
    .tack { width: 2px; background: #e2e8f0; margin-right: 20px; flex-shrink: 0; height: 15px; }
    .tack.major { height: 38px; background: #94a3b8; position: relative; }
    .tack.major::after { content: attr(data-val); position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 800; color: #94a3b8; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

  <div id="drop-delete-zone">
      <span class="text-4xl mb-1">üóëÔ∏è</span>
      <span class="text-[10px] font-black uppercase tracking-widest">Rilascia per eliminare</span>
  </div>

  <div class="page">
      <header class="p-5 flex justify-between items-center bg-[#0f172a]">
          <div class="text-white font-black italic text-lg tracking-tighter">CHEF<span class="text-amber-500">ACADEMY</span></div>
          <span class="text-[8px] font-bold text-white/30 uppercase tracking-[0.4em]">v3.0.1 Stable</span>
      </header>

      <div class="sticky-output">
          <div class="liquid-bg" id="liquid"></div>
          <div class="relative z-10 flex items-center justify-between">
              <div class="bg-white/5 backdrop-blur-md p-4 rounded-3xl border border-white/10 text-center min-w-[80px]">
                  <span id="mainEmoji" class="text-4xl block mb-1">ü•Ñ</span>
                  <span id="toolLabel" class="text-[8px] font-black text-amber-500 uppercase">Cucchiaio</span>
              </div>
              <div class="flex-1 px-6 text-white">
                  <div class="flex items-baseline leading-none">
                      <span id="intDisplay" class="text-7xl font-black tracking-tighter">0</span>
                      <span class="text-xs font-bold text-amber-500 ml-2">DOSI</span>
                  </div>
                  <p id="kcalDisplay" class="text-[10px] font-bold text-white/30 uppercase mt-2 tracking-widest">0 KCAL</p>
              </div>
              <button onclick="saveFavorite()" class="bg-amber-500 text-slate-900 p-5 rounded-[2rem] shadow-2xl active:scale-95 transition-all">
                  <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M12 6v12m6-6H6"></path></svg>
              </button>
          </div>
      </div>

      <main class="flex-1 overflow-y-auto no-scrollbar px-5 py-6 space-y-6">
          <div id="favoritesList" class="flex space-x-4 overflow-x-auto no-scrollbar min-h-[100px] items-center"></div>

          <div class="space-y-4">
              <div class="bg-white rounded-[2.2rem] p-2 shadow-sm">
                  <button onclick="toggleCollapse('food-section')" class="w-full flex justify-between p-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Ingredienti <span id="food-section-icon">‚ñº</span></button>
                  <div id="food-section" class="collapsible-content open"><div class="grid grid-cols-3 gap-3 p-3" id="foodGrid"></div></div>
              </div>

              <div class="bg-white rounded-[2.2rem] p-2 shadow-sm">
                  <button onclick="toggleCollapse('tool-section')" class="w-full flex justify-between p-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Dosatori <span id="tool-section-icon">‚ñ∂</span></button>
                  <div id="tool-section" class="collapsible-content"><div class="grid grid-cols-3 gap-3 p-3" id="toolGrid"></div></div>
              </div>
          </div>
      </main>

      <footer class="bg-white border-t border-slate-100">
          <div class="flex justify-between items-center px-8 py-4">
              <button onclick="resetGrams()" class="text-[10px] font-black text-red-400 uppercase">Reset</button>
              <div class="text-5xl font-black text-slate-800 tracking-tighter"><span id="gramsDisplay">0</span><span class="text-sm text-amber-500 ml-1">G</span></div>
          </div>
          <div class="ruler-container" id="ruler">
              <div class="absolute left-1/2 -translate-x-1/2 bottom-0 w-1.5 h-12 bg-amber-500 z-30 rounded-t-full shadow-lg"></div>
              <div class="ruler-track" id="track"></div>
          </div>
      </footer>
  </div>

  <script>
    const db = {
      farina: { name: "Farina", emoji: "üåæ", kcal: 364, w: { cucchiaio: 12, cucchiaino: 4, tazzina: 60, bicchiere: 120, tazza: 140, pugno: 30 } },
      olio: { name: "Olio", emoji: "ü´í", kcal: 884, w: { cucchiaio: 9, cucchiaino: 3, tazzina: 80, bicchiere: 180, tazza: 200, pugno: 10 } },
      riso: { name: "Riso", emoji: "üçö", kcal: 130, w: { cucchiaio: 20, cucchiaino: 7, tazzina: 90, bicchiere: 220, tazza: 250, pugno: 45 } },
      zucchero: { name: "Zucchero", emoji: "üç¨", kcal: 387, w: { cucchiaio: 15, cucchiaino: 5, tazzina: 80, bicchiere: 180, tazza: 200, pugno: 25 } },
      sale: { name: "Sale", emoji: "üßÇ", kcal: 0, w: { cucchiaio: 18, cucchiaino: 6, tazzina: 110, bicchiere: 250, tazza: 280, pugno: 35 } },
      cacao: { name: "Cacao", emoji: "üç´", kcal: 228, w: { cucchiaio: 8, cucchiaino: 3, tazzina: 45, bicchiere: 90, tazza: 110, pugno: 20 } }
    };
    const toolIcons = { cucchiaio: 'ü•Ñ', cucchiaino: 'üç¥', tazzina: '‚òï', bicchiere: 'ü•É', tazza: 'ü•õ', pugno: '‚úä' };
    
    let state = { food: 'farina', tool: 'cucchiaio', grams: 0, favorites: [] };
    let currentX = 0;

    // AUDIO ENGINE
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, dur) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function init() {
        const fGrid = document.getElementById('foodGrid');
        Object.keys(db).forEach(k => {
            const div = document.createElement('div');
            div.className = `p-4 flex flex-col items-center bg-slate-50 rounded-2xl border-2 border-transparent transition-all`;
            div.innerHTML = `<span class="text-3xl mb-1">${db[k].emoji}</span><span class="text-[9px] font-black uppercase text-slate-500">${db[k].name}</span>`;
            div.onclick = () => { 
                state.food = k; updateUI(); 
                document.querySelectorAll('#foodGrid > div').forEach(i => i.style.borderColor = 'transparent');
                div.style.borderColor = '#fbbf24';
            };
            fGrid.appendChild(div);
        });

        const tGrid = document.getElementById('toolGrid');
        Object.keys(toolIcons).forEach(k => {
            const div = document.createElement('div');
            div.className = `p-4 flex flex-col items-center bg-slate-50 rounded-2xl border-2 border-transparent transition-all`;
            div.innerHTML = `<span class="text-3xl mb-1">${toolIcons[k]}</span><span class="text-[9px] font-black uppercase text-slate-500">${k}</span>`;
            div.onclick = () => { 
                state.tool = k; updateUI(); 
                document.querySelectorAll('#toolGrid > div').forEach(i => i.style.borderColor = 'transparent');
                div.style.borderColor = '#fbbf24';
            };
            tGrid.appendChild(div);
        });

        const track = document.getElementById('track');
        for(let i=0; i<=500; i++) {
            const t = document.createElement('div');
            t.className = i%10===0 ? 'tack major' : 'tack';
            if(i%10===0) t.setAttribute('data-val', i);
            track.appendChild(t);
        }
        setupRuler();
        updateUI();
    }

    function setupRuler() {
        const r = document.getElementById('ruler');
        let startX = 0, isDown = false;
        r.ontouchstart = (e) => { isDown = true; startX = e.touches[0].clientX - currentX; };
        window.addEventListener('touchmove', (e) => {
            if (!isDown) return;
            let x = e.touches[0].clientX - startX;
            if (x > 0) x = 0;
            currentX = x;
            let newGrams = Math.abs(Math.round(x/22));
            if(newGrams !== state.grams) {
                state.grams = newGrams;
                updateUI();
            }
        }, { passive: false });
        window.addEventListener('touchend', () => isDown = false);
    }

    function updateUI() {
        const f = db[state.food];
        const tw = f.w[state.tool];
        const units = state.grams / tw;
        const perc = (units % 1) * 100;

        document.getElementById('intDisplay').innerText = Math.floor(units);
        document.getElementById('gramsDisplay').innerText = state.grams;
        document.getElementById('track').style.transform = `translateX(${currentX}px)`;
        document.getElementById('kcalDisplay').innerText = Math.round((f.kcal * state.grams) / 100) + " KCAL";
        document.getElementById('mainEmoji').innerText = toolIcons[state.tool];
        document.getElementById('toolLabel').innerText = state.tool;
        
        document.documentElement.style.setProperty('--p-level', (perc === 0 && units > 0 ? 100 : perc) + '%');
        
        // Haptic + Sound on full dose
        if(state.grams > 0 && state.grams % tw === 0) {
            navigator.vibrate?.(15);
            playSound(440, 'sine', 0.05);
        }
    }

    function saveFavorite() {
        if(state.grams === 0) return;
        state.favorites.unshift({ id: Date.now(), grams: state.grams, emoji: db[state.food].emoji });
        playSound(880, 'sine', 0.1);
        renderFavorites();
    }

    function renderFavorites() {
        const list = document.getElementById('favoritesList');
        const zone = document.getElementById('drop-delete-zone');
        list.innerHTML = '';
        state.favorites.forEach(f => {
            const div = document.createElement('div');
            div.className = "fav-item";
            div.innerHTML = `<span class="text-2xl block">${f.emoji}</span><span class="text-[10px] font-black">${f.grams}g</span>`;
            
            let sX, sY, rect;
            div.ontouchstart = (e) => { 
                rect = div.getBoundingClientRect();
                sX = e.touches[0].clientX - rect.left;
                sY = e.touches[0].clientY - rect.top;
                div.classList.add('fav-dragging');
                div.style.left = rect.left + 'px';
                div.style.top = rect.top + 'px';
                zone.classList.add('visible'); 
                navigator.vibrate?.(5);
            };
            div.ontouchmove = (e) => { 
                e.preventDefault();
                div.style.left = (e.touches[0].clientX - sX) + 'px';
                div.style.top = (e.touches[0].clientY - sY) + 'px';
                if(e.touches[0].clientY < 130) zone.style.background = "#ff0000";
                else zone.style.background = "#ef4444";
            };
            div.ontouchend = (e) => {
                zone.classList.remove('visible');
                if(e.changedTouches[0].clientY < 130) {
                    state.favorites = state.favorites.filter(x => x.id !== f.id);
                    playSound(150, 'sawtooth', 0.2);
                    renderFavorites();
                } else { 
                    div.classList.remove('fav-dragging');
                    div.style.position = 'relative';
                    div.style.left = '0'; div.style.top = '0';
                }
            };
            list.appendChild(div);
        });
    }

    function toggleCollapse(id) {
        const el = document.getElementById(id);
        const icon = document.getElementById(id + '-icon');
        const isOpen = el.classList.contains('open');
        el.classList.toggle('open');
        icon.innerText = isOpen ? '‚ñ∂' : '‚ñº';
    }

    function resetGrams() { currentX = 0; state.grams = 0; updateUI(); }
    init();
  </script>
</body>
</html>
